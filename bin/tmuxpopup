#!/usr/bin/env bash

cmd=$1

session="_popup_${cmd}_$(pwd)"
current_session="$(tmux display -p '#S')"


# If the current session is already the target session, detach it
if [ "$session" = "$current_session" ]; then
  tmux detach -s "$session"
  exit 0
fi

if ! tmux has -t "$session" 2> /dev/null; then
  parent_session="$(tmux display -p '#{session_id}')"
  session_id="$(tmux new-session -A -dP -s "$session" -F '#{session_id}' -e TMUX_PARENT_SESSION="$parent_session" $@)"
  tmux set-option -s -t "$session_id" key-table popup
  tmux set-option -s -t "$session_id" status off
  tmux set-option -s -t "$session_id" detach-on-destroy on
  # tmux set-option -s -t "$session_id" prefix None
  session="$session_id"
fi

exec tmux attach -t "$session" > /dev/null
