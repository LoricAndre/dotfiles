#!/usr/bin/env bash

SCRIPT_PATH="$(realpath "$0")"

list() {
  while [ $# -gt 0 ]; do
    case $1 in
      --ignore-class)
        ignore_class="$2";
        shift 2;
        ;;
    esac
  done

  clients="$(hyprctl clients -j)"
  zed_wins=$(echo "$clients" | jq -r 'map(select((.class | startswith("dev.zed.Zed")) and (.grouped != []))) | sort_by(.focusHistoryID) | map("\(. as $client | $client.grouped | map(. == $client.address) | index(true) + 1):\(.title)") | .[]')

  current_window=$(echo "$clients" | jq -r "map(select((.class !=\"$ignore_class\"))) | min_by(.focusHistoryID) | .title")

  echo -e "$zed_wins"
  zoxide query -l | head -n 50 | while read d; do
    if ! echo "$zed_wins\n$current_window" | grep -q ":$(basename "$d") â€” "; then
      echo "$d"
    fi
  done
}

run() {
  args=$@
  while [ $# -gt 0 ]; do
    case $1 in
      --ignore-class)
        ignore_class="$2";
        shift 2
        ;;
    esac
  done

  clients="$(hyprctl clients -j)"

  current_window=$(echo "$clients" | jq -r "map(select((.class !=\"$ignore_class\"))) | min_by(.focusHistoryID) | .address")
  list $args | sk \
      --preview 'tree {}' \
      --delimiter ':' \
      --tiebreak 'index,score,end'
      --bind "enter:execute(\"$SCRIPT_PATH\" swap $current_window {1} $@)+accept" \
      --bind "ctrl-d:execute(zoxide remove {})+reload(\"$SCRIPT_PATH\" list $@)" \
      --bind "alt-enter:execute(\"$SCRIPT_PATH\" swap 0x000000000 {1} $@)+accept"
}

swap() {
  current_window="$1"
  target="$2"

  echo "$current_window -> $target"

  hyprctl dispatch focuswindow "address:$current_window"
  if [[ $target =~ ^[0-9]$ ]]; then
    echo "setting $target as group active window"
    hyprctl dispatch changegroupactive $target
  else
    echo "opening a new zed instance at $target"
    zeditor "$target"
  fi
}


if [ -z "$1" ]; then
  run $@
else
  case $1 in
    swap)
      shift;
      swap $@;
      ;;
    list)
      shift;
      list $@;
      ;;
    *)
      run $@
      ;;
  esac
fi